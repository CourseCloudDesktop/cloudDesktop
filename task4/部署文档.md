# task4 部署文档
## 一、task3 补充部分
在上次的作业中我们直接用了img镜像文件，没有正确理解作业要求，所以这次选择ubuntu-14.04.1-desktop-amd64.iso版本，重新用iso文件制作格式为qcow2的镜像，上传并启动实例。  
制作镜像前要开启CPU支持虚拟化，vmware具体操作为：虚拟机-设置-硬件-处理器-虚拟化引擎-勾选[虚拟化Intel VT-x/EPT 或 AMD-V/RVI(V)]。

**1.用filezilla将iso镜像上传至虚拟机/root目录下，之后创建系统盘ubuntu_image.qcow2**  
创建系统盘命令：  
`qemu-img create -f qcow2 ubuntu_image.qcow2 20G`  
ls命令显示/root目录下创建好的ubuntu_image.qcow2和上传的iso文件：  
![上传iso创建系统盘](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/1_上传iso创建系统盘.PNG)  

**2.qemu-system-x86命令开启虚拟机，用vnc viewer连接后制作镜像**  
参考[博客](https://blog.csdn.net/wanghuiyao/article/details/65627198)，利用kvm命令（qemu-system-x86_64）在虚拟机中启动虚拟机、制作需要的镜像。  
![启动虚拟机](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/2_启动虚拟机.PNG)  
添加参数-vnc ：3，设置将视频流输出到vnc管道，远端可以使用虚拟机的ip和vnc的端口，使用vnc viewer连接  
![vnc连接](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/3_vnc连接.PNG)  
vnc view连接到打开的虚拟机，按照安装指示完成ubuntu的安装部分，之后创建一个文件写入小组branch名称，完成镜像的制作，关掉vnc viewer即可。  

**3.用命令行上传制作好的qcow2镜像**  
也可以通过filezilla将/root目录下的ubuntu_image.qcow2下载下来再通过网页上传，不过由于镜像较大，网页上传速度较慢，选择了用命令行直接上传。  
![创建映像](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/4_创建映像.PNG)  
上传成功后，可以在dashboard中查看到上传的映像：  
![dashboard查看映像](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/5_dashboard查看映像.PNG)  

**4.用上传的qcow2镜像启动一个新的实例**  
创建实例的过程在前几次作业中都有涉及，不再赘述，创建好实例后可以成功开启，从控制台进入实例，不需要再安装系统，打开的就是之前制作好的系统  
![控制台进入实例](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/6_控制台进入实例.PNG)  
利用制作镜像时设置的用户及密码进入系统，桌面上有之前已经做好的写有分支名称的文件  
![显示小组文件](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/7_显示小组文件.PNG)  

## 二、子任务1：虚拟网络部分配置  
遇到问题：
最初配置网络时尝试用宿舍校园网的网线插口连接网络，但是实例并不能成功ping通主机，ping内网网关、浮动ip和外部网络的网关都可以ping通，但是ping不通外部网络的子网网关，认为还是宿舍校园网的问题，因为在设置桥接后，虚拟机并没有动态分配到ip地址，如果将网卡2的ip地址设置为静态ip，虚拟机启动时就会显示网络没有完整设置。随后用连接wifi进行实验，没有出错。 

具体步骤：   
**1.将网卡2的网络适配器设为桥接模式**  
![eth1桥接](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/8_eth1桥接.PNG)  
桥接模式桥接的网卡默认是自动选择的，这里可以手动更改为主机的无线网卡，vmware操作为：编辑-虚拟网络编辑器-更改桥接模式桥接到主机的无线网卡(此处要自己选择主机的网卡)。  

**2.查看虚拟机是否动态分配到ip**  
将网络适配器设为桥接模式后，又更改了/etc/network/interfaces文件，设置eth1动态获取ip。  
主机的ip地址为：  
![主机ip](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/9_主机ip.PNG)  
虚拟机中查看eth1分配到的ip为：  
![虚拟机eth1](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/10_虚拟机eth1.PNG)  
可以看到主机和虚拟机eth1网卡的ip地址在同一网段中。  

**3.更改外网、路由器、安全组规则、浮动ip的设置**  
更改外网网络配置，外网类型采用flat，外网子网和主机网络处在同一网段中  
![外网设置](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/11_外网设置.PNG)  
对路由器清除网关，重新设置网关  
![路由器网关重设](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/12_路由器网关重设.PNG)  
更改安全组规则  
![安全组规则](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/13.5_安全组规则.PNG)  
外网的ip改变了，那么实例的浮动ip就要重新分配，下面截图显示了重设后的浮动ip  
![浮动ip重设](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/13_浮动ip重设.PNG)

**4.检查实例是否能ping通外网**  
首先检查了实例和主机是否能互相ping通  
主机ping实例可以ping通：  
![主机ping实例](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/15_主机ping实例.PNG)  
实例ping主机也可以ping通：  
![实例ping主机](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/16_实例ping主机.PNG)  
检查实例是否能ping通外网，可以ping通  
![实例ping外网](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/17_实例ping外网.PNG)  

**5.用xshell连接实例**  
xshell新建会话，主机那里填写实例的浮动ip  
![新建会话](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/19_新建会话.PNG)  
连接这个新建会话，填写实例的用户名和密码  
![用户名](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/20_用户名.PNG)  
![密码](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/21_密码.PNG)  
可以看到连接成功  
![xshll连接](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/22_xshll连接.PNG)
## 三、子任务2：镜像制作  
本部分内容已经在上述[一、task3 补充部分](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/部署文档.md#一task3-补充部分)完成，任务结果截图可看上面部分内容。

## 四、子任务3：安装云桌面   
**1.上传安装脚本并解压**  
用filezilla将安装脚本上传至/root目录下，ls命令查看上传的脚本，解压脚本  
![上传并解压](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/23.上传并解压.PNG)  

**2.进入build文件夹，编辑localrc参数文件**  
安装脚本解压后可以看到一个build文件  
![build](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/24_build.PNG)  
进入build文件集，根据部署手册编辑localrc参数文件。  

**3.运行脚本，安装云桌面**  
运行./run.sh，安装成功  
![安装成功](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/25_安装成功.PNG)  

**4.安装后工作**  
检查服务状态  
![验证](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/26_验证.PNG)  
部署手册上还有一步要修改系统配置文件，但是进去配置文件后发现要修改的地方已经是正确的了，就不用再修改了。  

**5.打开系统**  
在浏览器网址栏输入openstack节点的ip，也就是虚拟机的ip地址  
![访问](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/27_访问.PNG)  
用户名admin，密码admin123登录系统  
![登陆成功](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/28_登陆成功.PNG)

**6.创建一个固定桌面**

登录云桌面后，点击固定桌面，然后选择创建桌面。创建之前需要确保，OpenStack中存在一个用于连接实例的子网。虚拟网络需要选择该子网。而镜像就是选择再OpenStack中加载了的镜像
![](https://github.com/CourseCloudDesktop/cloudDesktop/raw/wcl-develop/task4/images/1.PNG)
确认之后，就会开始创建桌面
![](https://github.com/CourseCloudDesktop/cloudDesktop/raw/wcl-develop/task4/images/2.PNG)
点击创建好的固定桌面就会进入控制台界面
![](https://github.com/CourseCloudDesktop/cloudDesktop/raw/wcl-develop/task4/images/3.PNG))

  ---------------
  小组成员分工合作完成本次任务。