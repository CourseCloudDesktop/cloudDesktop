# task3学习周报

## 本周具体工作内容  
- task3部分任务补充，上次作业直接用了img镜像，本次重新用iso镜像制作qcow2镜像，上传并开启。
- 虚拟网络部分配置
- 镜像制作
- 安装云桌面
## 本周主要工作内容
### 已经完成工作
- **重新制作qcow2镜像并开启实例。**  
将需要制作镜像的iso文件上传至虚拟机，用qemu-img命令创建qcow2格式的镜像，用qemu-system-x86命令启动iso镜像，通过vnc viewer连接开始制作镜像，首先要安装ubuntu系统，安装后按新建了一个文件以便之后验证。完成后就需要把qcow2镜像上传，可以用通过dashboard用网页上传，也可以直接用命令上传镜像。映像上传后可以在dashboard上创建实例，之后开启实例。

- **配置网络环境使实例可以ping通外网，并用xshell连接实例**  
这里主要改变的是外网配置。首先将虚拟机的第二个网卡改为桥接模式，因为第二个网卡提供的网络是provider network，openstack内部的网络都是建立在provider network上的，所以想要实例能ping通外网，provider network也要能够连接到外网。改为桥接模式后，虚拟机第二个网卡可以动态获得ip，和主机ip是在同一网段的，修改外网设置是它和主机网络在同一网段，之后对路由器清除网关，重新设置网关，实例关联的浮动ip也要重新设置。这样网络基本上没有问题了，实例是可以连接外网的。当然也会出现一些其他的问题，我在下面[问题与困难]()部分会记录遇到的问题和解决方法。   

- **制作镜像**  
这部分内容在task3任务补充部分已经完成了。

- **上传云桌面安装脚本进行安装**  
  这个部分没有什么问题，只要按照部署手册操作就可以成功安装了。
### 未完成工作
- 无
### 问题与困难
- **改为桥接模式后虚拟机分配不到ip**  
我是在宿舍做实验的，一开始用宿舍的网线插口连接网络，但是虚拟机一直不能动态获取到ip，用命令`ifconfig eth1`查看网卡eth1查看ip地址时，发现并没有，所以怀疑宿舍网络并不是动态分配ip的，因为观察发现在宿舍用inode上网时获得的ip地址始终没有变过。之后连接wifi，桥接至主机无线网卡，虚拟机成功获取ip。

- **重新配置虚拟网络后，主机可以ping通实例，但实例却ping不通主机**  
既然主机能ping通实例，那就说明网络部分是连通的，查看安全组规则也是正确的。这里的问题在主机防火墙设置的问题，不需要关闭防火墙，只需要打开windows防火墙的ICMP4-in规则，启用规则后实例和主机就可以互相ping通了。具体操作：打开防火墙和网络保护-选择高级设置-入站规则-找到配置文件类型为“专用、共用”的“文件和打印共享（回显请求-ICMPv4）规则”-启用规则。  
![主机防火墙设置](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/14_主机防火墙设置.PNG)

- **实例能ping通外网，但是xshell却连接不上**  
安全组也设置了ssh，这里的问题在于我制作镜像的时候忘记安装ssh服务了。用命令`ps -e|grep ssh`命令检查是否安装和启用了ssh服务，如果有sshd，证明已经安装好了ssh-server并启用，我当时只看到只有ssh-agent，这个是ssh-client客户端服务，所以要安装ssh server，用命令`apt install openssh-server`安装，安装好后再次检查，之后xshell就可以连通实例了。  
![ssh](https://github.com/CourseCloudDesktop/cloudDesktop/blob/wcl-develop/task4/images/18_检查ssh.PNG)


## 下周工作计划
- 进行下一阶段的学习