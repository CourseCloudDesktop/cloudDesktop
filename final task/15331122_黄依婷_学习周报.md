# 学习周报  
### 主要工作  
* 了解openstack nova组件的功能  
* nova主键的conductor模块的源码分析  
* ppt的制作  
### nova组件的功能  
* nova的核心组件有nova api, nova conductor, nova scheduler, nova compute  
<img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/kek-develop/final%20task/pic/y1.png" width="70%">
  
* 组件的主要作用：  
  * Api: 主要是接收Http请求（通常来自于client）。通过messaging来和conductor和compute进行交互。  
  * Conductor: 为避免nova compute直接和数据库进行操作，作为一个数据库代理存在。  
  * Compute: 主要是操纵计算节点上的hypervisor对实例进行创建和管理。  
  * Scheduler: 主要是用力啊判断新创建的实例应该放在哪一个计算节点上。  
  
### 创建实例过程中的conductor组件源码分析：  
* Conductor/_init_.py  
  ComputeTaskAPI对象的定义:  
  <img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/kek-develop/final%20task/pic/y2.png" width="50%">  
      
* Conductor/api.py  
  build_instances()方法调用了conductor_compute_rpcapi对象的build_instances()方法。  
  <img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/kek-develop/final%20task/pic/y3.png" width="70%">  
  <img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/kek-develop/final%20task/pic/y4.png" width="70%">  
      
* Conductor/Rpcapi.py  
  专门处理nova组件之间的RPC调用。  
  <img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/kek-develop/final%20task/pic/y5.png" width="70%">  
   ···  
  <img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/kek-develop/final%20task/pic/y6.png" width="70%">  
    
* Conductor/manager.py  
  <img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/kek-develop/final%20task/pic/y7.png" width="70%">
  <img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/kek-develop/final%20task/pic/y8.png" width="70%">  
  其中，build_instance()方法会调用scheduler_client.select_destinations()和compute_rpcapi.build_and_run_instance()  
  * cheduler_client.select_destinations()会调用schedular的RPC API选择在哪些主机上创建instance。  
    <img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/kek-develop/final%20task/pic/y9.png" width="70%">  
  * compute_rpcapi.build_and_run_instance()会通过RPC请求nova-compute服务去构建和运行instance。  
    <img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/kek-develop/final%20task/pic/y10.png" width="70%">  
  
* Conductor/manager.py的整个调用过程：  
  build_and_run_instance() --> _do_build_and_run_instance() --> _build_and_run_instance() --> driver.spawn()  
    
* driver对象：  
  * (manager.py)  
    <img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/kek-develop/final%20task/pic/y11.png" width="70%">  
  * nova/virt/driver.py里定义:  
    <img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/kek-develop/final%20task/pic/y12.png" width="70%">
    <img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/kek-develop/final%20task/pic/y13.png" width="70%">
    
