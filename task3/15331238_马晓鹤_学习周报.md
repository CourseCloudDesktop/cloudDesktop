# 学习周报

* [本周具体工作计划](#本周具体工作计划)
* [本周主要工作内容](#本周主要工作内容)
* [下周工作计划](#下周工作计划)
* [建议与意见](#建议与意见)

----------
<h3 id="本周具体工作计划"> 1. 本周具体工作计划</h3>

* 制作windows7或者centos7或者ubuntu的镜像，格式为qcow2
* 利用openstack上传镜像
* 能够成功创建、开启实例

<h3 id="本周主要工作内容"> 2. 本周主要工作内容</h3>

* 制作镜像：先下载要制作镜像的iso文件，启动系统
* 用命令行/dashboard创建镜像
* 查看镜像的信息、服务
* 创建实例
* 尝试用xshell或者桌面远程连接实例（安全组）

#### （1）已经完成的工作
##### iso和qcow2、img格式的区别
 
* IMG是一种文件压缩格式，主要是为了创建磁盘的映像文件，它可以用来压缩整个磁盘或整片光盘的内容，使用".IMG"这个扩展名的文件就是利用这种文件格式来创建的。.IMG这个文件格式可视为.ISO格式的一种超集合。由于.ISO只能压缩使用ISO9660和UDF这两种文件系统的存储媒介，意即.ISO只能拿来压缩CD或DVD，因此才发展出了.IMG，它是以.ISO格式为基础另外新增可压缩使用其它文件系统的存储媒介的能力，.IMG可向后兼容于.ISO，如果是拿来压缩CD或DVD，则使用.IMG和.ISO这两种格式所压缩出来的内容是一样的。

* QCOW2：

	* 更小的空间占用，即使文件系统不支持空洞(holes)；
	* 支持写时拷贝（COW, copy-on-write），镜像文件只反映底层磁盘的变化；
	* 支持快照（snapshot），镜像文件能够包含多个快照的历史；
	* 可选择基于 zlib 的压缩方式
	* 可以选择 AES 加密

##### 为什么要自己制作镜像

如果每次都用原始的纯净版镜像创建实例，则要每次都重复安装、配置环境，定制镜像则可以保存好配置好的环境与磁盘状态，可以根据需要定制特殊的镜像直接使用，开启实例可以直接打开无需安装，提高了效率。  

##### 镜像制作到启动的步骤总结
  
一、环境准备
首先设置虚拟机处理器支持虚拟化：
![这里写图片描述](https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A31.png)
检查设置虚拟化成功（有输出代表成功）：

```
# egrep -o '(vmx|svm)' /proc/cpuinfo
```

<img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A32.png" width=75%>

二、安装kvm

```
# sudo apt-get install qemu-kvm libvirt-bin kvm qemu virt-manager bridge-utils
```

其中：`virt-manager`为GUI管理窗口，`bridge-utils`用于网络桥接。

* 测试kvm是否安装成功

```
# kvm-ok
```

* 验证kvm内核是否加载成功

```
# lsmod | grep kvm
```

* 验证kvm正常运行

```
# virsh -c qemu:///system list
```

<img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A33.png" width=75%>

三、制作ubuntu-14.04.5-server-amd64.iso镜像

1、首先创建一个空镜像，这块镜像用作硬盘，留出所需的空间的大小：

```
# qemu-img create -f qcow2 source_image.qcow2 20G
```

2、将iso文件上传至虚拟机，置入某个文件夹，启动kvm一个虚拟机实例。输入如下命令，它将在端口5开放vnc服务。

```
# qemu-system-x86_64 -m 512 -smp 4 --enable-kvm -boot d -hda /home/image/source_image.qcow2 -cdrom /home/image/ubuntu-14.04.5-server-amd64.iso -vnc :5
```

![这里写图片描述](https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A34.png)

3、使用VncViewer远程连接实例并完成安装

 <img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A35.png" width=75%>
 
<img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A36.png" width=65%>

四、创建实例

1、将制作的镜像从虚拟机下载到物理机上。

<img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A38.png" width=70%>

2、在dashboard上传映像

 ![这里写图片描述](https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A39.png)
 
3、以该镜像创建实例
 ![这里写图片描述](https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A310.png)
 
4、成功开启实例且无需重复安装，证明成功。
 ![这里写图片描述](https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A311.png)
 
##### 跟镜像相关的openstack的一些命令了解

* 帮助

```
glance help  | grep image  
              [--os-image-url OS_IMAGE_URL] [-U OS_IMAGE_URL]  
              [--os-image-api-version OS_IMAGE_API_VERSION]  
    add                 DEPRECATED! Use image-create instead.  
    delete              DEPRECATED! Use image-delete instead.  
    details             DEPRECATED! Use image-list instead.  
    image-create        Create a new image.  
    image-delete        Delete specified image(s).  
    image-download      Download a specific image.  
    image-list          List images you can access.  
    image-members       DEPRECATED! Use member-list instead.  
    image-show          Describe a specific image.  
    image-update        Update a specific image.  
    index               DEPRECATED! Use image-list instead.  
    member-create       Share a specific image with a tenant.  
    member-delete       Remove a shared image from a tenant.  
    member-images       DEPRECATED! Use member-list instead.  
    member-list         Describe sharing permissions by image or tenant.  
    show                DEPRECATED! Use image-show instead.  
    update              DEPRECATED! Use image-update instead.  
```

* 上传qcow2镜像

```
 glance image-create --name IMAGE_NAME --file IMAGE_FILEPATH --disk-format qcow2 --container-format bare --is-public true --progress   
 openstack image create --disk-format qcow2 --container-format bare --public --IMAGE_FILEPATH IMAGE_NAME

```
* 上传iso镜像

```
openstack image create ISO_IMAGE --file IMAGE.iso --disk-format iso --container-format bare
```

* 查看镜像列表

```
openstack image list
```

* 过滤只留下名称含有'cirros'的镜像

```
openstack image list | grep 'cirros'
```
* 查看特定镜像相关信息

```
openstack image show CirrosImageName
```
* 查看flavor列表

```
openstack flavor list
```
* 查看镜像的位置信息

```
openstack --os-image-api-version 2 image show imageID

```

* 更新镜像

```
openstack image set imageName
```

* 查看日志或错误信息

```
 cat /var/log/nova/nova-compute.log 
 cat /var/log/nova/nova-conductor.log 
 cat /var/log/nova/nova-scheduler.log
 cat /var/log/nova/nova-api.log 
```

#### （2）未完成的工作
无。   

#### （3）问题与困难
* 目前对OpenStack的了解还不是很深入，出现问题查看nova-compute.log 等日志文件也无法判断出错原因
<h3 id="下周工作计划"> 3. 下周工作计划</h3>

<h3 id="建议与意见"> 4. 建议与意见</h3>
希望TA可以开一次会讲一下OpenStack的原理和我们的任务明确是要做什么，对我们遇到的一些问题的指导，从实训到现在还是很迷茫
