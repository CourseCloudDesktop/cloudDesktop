## task3操作文档

### 一、环境准备
OS：Ubuntu-14.04.5-server
制作镜像版本：ubuntu-14.04.5-server-amd64.iso和ubuntu-16.04.3-desktop-amd.iso

首先设置虚拟机处理器支持虚拟化：
![这里写图片描述](https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A31.png)
检查设置虚拟化成功（有输出代表成功）：

```
# egrep -o '(vmx|svm)' /proc/cpuinfo
```

<img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A32.png" width=75%>

### 二、安装kvm

```
# sudo apt-get install qemu-kvm libvirt-bin kvm qemu virt-manager bridge-utils
```

其中：`virt-manager`为GUI管理窗口，`bridge-utils`用于网络桥接。

* 测试kvm是否安装成功

```
# kvm-ok
```

* 验证kvm内核是否加载成功

```
# lsmod | grep kvm
```

* 验证kvm正常运行

```
# virsh -c qemu:///system list
```

<img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A33.png" width=75%>

### 三、制作ubuntu-14.04.5-server-amd64.iso镜像

1、首先创建一个空镜像，这块镜像用作硬盘，留出所需的空间的大小：

```
# qemu-img create -f qcow2 source_image.qcow2 20G
```

2、将iso文件上传至虚拟机，置入某个文件夹，启动kvm一个虚拟机实例。输入如下命令，它将在端口5开放vnc服务。

```
# qemu-system-x86_64 -m 512 -smp 4 --enable-kvm -boot d -hda /home/image/source_image.qcow2 -cdrom /home/image/ubuntu-14.04.5-server-amd64.iso -vnc :5
```

![这里写图片描述](https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A34.png)

3、使用VncViewer远程连接实例并完成安装

 <img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A35.png" width=75%>
 
<img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A36.png" width=65%>

### 四、创建实例

1、将制作的镜像从虚拟机下载到物理机上。

<img src="https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A37.png" width=70%>

2、在dashboard上传映像

 ![这里写图片描述](https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A38.png)
 
3、以该镜像创建实例
 ![这里写图片描述](https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A39.png)
 
4、成功开启实例且无需重复安装，证明成功。
 ![这里写图片描述](https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A310.png)
 
### 五、制作ubuntu-16.04.3-desktop-amd.iso镜像
制作镜像步骤相同，为了证明制作镜像成功，在vncViewer安装好虚拟机后，在虚拟机中新建了一个txt文件，以此定制镜像。
desktop的镜像过大，采用命令行方式上传。

![这里写图片描述](https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A311.png)

![这里写图片描述](https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A312.png)

启动一个实例，txt文件存在，证明定制镜像成功。
![这里写图片描述](https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A313.png)

![这里写图片描述](https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A314.png)

![这里写图片描述](https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A315.png)

在此实例中再创建一个txt文件，给该实例创建快照，再以该快照为镜像创建一个新实例。

![这里写图片描述](https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A316.png)

![这里写图片描述](https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A317.png)

开启实例，实例中存在两个txt文件，说明快照也创建成功，保存了上一个实例的磁盘状态。

![这里写图片描述](https://github.com/CourseCloudDesktop/cloudDesktop/blob/mlp-develop/task3/images/%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A318.png)

